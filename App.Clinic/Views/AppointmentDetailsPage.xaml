<?xml version="1.0" encoding="utf-8" ?>
<ContentPage 
    xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
    xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
    xmlns:viewmodels="clr-namespace:App.Clinic.ViewModels"
    xmlns:dto="clr-namespace:Library.Clinic.DTO;assembly=Library.Clinic"
    x:Class="App.Clinic.Views.AppointmentDetailsPage"
    x:DataType="viewmodels:AppointmentDetailsViewModel"
    Title="Appointment Details">
    
    <ScrollView>
        <StackLayout Padding="20" Spacing="20">
            
            <!-- Header -->
            <Label Text="Appointment Information"
                   FontSize="24"
                   FontAttributes="Bold"
                   HorizontalOptions="Center"
                   Margin="0,0,0,20" />
            
            <!-- Patient Picker -->
            <Label Text="Patient" FontAttributes="Bold" />
            <Picker ItemsSource="{Binding Patients}"
                    ItemDisplayBinding="{Binding Name}"
                    SelectedItem="{Binding SelectedPatient}"
                    Title="Select a patient" />
            
            <!-- Physician Picker -->
            <Label Text="Physician" FontAttributes="Bold" />
            <Picker ItemsSource="{Binding Physicians}"
                    ItemDisplayBinding="{Binding Name}"
                    SelectedItem="{Binding SelectedPhysician}"
                    Title="Select a physician" />

            <!-- Room Entry -->
            <Label Text="Room" FontAttributes="Bold" />
            <Entry Text="{Binding Room}"
                   Placeholder="Enter room (e.g., 101)" />
            
            <!-- Date Picker -->
            <Label Text="Date" FontAttributes="Bold" />
            <DatePicker Date="{Binding Date}"
                        MinimumDate="{Binding MinDate}" />
            
            <!-- Start Time -->
            <Label Text="Start Time" FontAttributes="Bold" />
            <TimePicker Time="{Binding StartTime}" />
            
            <!-- End Time -->
            <Label Text="End Time" FontAttributes="Bold" />
            <TimePicker Time="{Binding EndTime}" />
            
            <!-- Reason Entry -->
            <Label Text="Reason for Visit" FontAttributes="Bold" />
            <Entry Text="{Binding Reason}"
                   Placeholder="Enter reason for appointment"
                   MaxLength="200" />
            
            <!-- Notes Editor -->
            <Label Text="Notes" FontAttributes="Bold" />
            <Editor Text="{Binding Notes}"
                    Placeholder="Enter any additional notes"
                    HeightRequest="100"
                    MaxLength="500"
                    AutoSize="TextChanges" />

            <!-- Treatments Management -->
            <Label Text="Treatments" FontAttributes="Bold" />
            <StackLayout Orientation="Horizontal" Spacing="10">
                <Entry Placeholder="Treatment name"
                       Text="{Binding NewTreatmentName}" WidthRequest="150" />
                <Entry Placeholder="Cost"
                       Keyboard="Numeric"
                       Text="{Binding NewTreatmentCostText}" WidthRequest="100" />
                <Button Text="Add" Command="{Binding AddTreatmentCommand}" />
            </StackLayout>

            <CollectionView ItemsSource="{Binding Treatments}" Margin="0,5,0,0">
                <CollectionView.ItemTemplate>
                    <DataTemplate x:DataType="dto:TreatmentDTO">
                        <Grid ColumnDefinitions="*,Auto" Padding="4" Margin="0,2">
                            <Label Grid.Column="0" Text="{Binding Name}" />
                            <StackLayout Grid.Column="1" Orientation="Horizontal" Spacing="8">
                                <Label Text="{Binding Cost, StringFormat='${0:F2}'}" />
                                <Button Text="Remove"
                                        Command="{Binding Source={RelativeSource AncestorType={x:Type viewmodels:AppointmentDetailsViewModel}}, Path=RemoveTreatmentCommand}"
                                        CommandParameter="{Binding .}" />
                            </StackLayout>
                        </Grid>
                    </DataTemplate>
                </CollectionView.ItemTemplate>
            </CollectionView>

            <Label Text="{Binding TotalCost, StringFormat='Total Cost: ${0:F2}'}"
                   FontAttributes="Bold"
                   HorizontalOptions="End" />
            
            <!-- Buttons -->
            <StackLayout Orientation="Horizontal" 
                         HorizontalOptions="Center" 
                         Spacing="20"
                         Margin="0,20,0,0">
                <Button Text="Save"
                        Command="{Binding SaveCommand}"
                        BackgroundColor="#007AFF"
                        TextColor="White"
                        WidthRequest="120" />
                <Button Text="Cancel"
                        Command="{Binding CancelCommand}"
                        BackgroundColor="#FF3B30"
                        TextColor="White"
                        WidthRequest="120" />
            </StackLayout>
            
        </StackLayout>
    </ScrollView>
</ContentPage>
